<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dramabox</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #1f2937;
    }

    ::-webkit-scrollbar-thumb {
      background: #4b5563;
      border-radius: 3px;
    }

    .card:hover .card-img {
      transform: scale(1.05);
    }

    .card-img {
      transition: transform 0.3s;
    }
  </style>
</head>

<body class="bg-gradient-to-b from-gray-900 via-gray-900 to-black text-white min-h-screen">
  <header class="sticky top-0 z-50 bg-gray-900/95 backdrop-blur border-b border-gray-800">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-4">
      <h1 class="text-xl font-bold text-cyan-400">Dramabox</h1>
      <div class="flex-1 flex gap-2">
        <input type="text" id="searchInput" placeholder="Cari drama..."
          class="flex-1 max-w-md px-4 py-2 rounded-full bg-gray-800 border border-gray-700 focus:outline-none focus:border-cyan-500 text-sm">
        <button onclick="searchDrama()"
          class="px-5 py-2 bg-cyan-600 rounded-full hover:bg-cyan-700 text-sm font-medium">Cari</button>
      </div>
      <select id="langSelect" onchange="clearCache(); loadHome()"
        class="px-3 py-2 bg-gray-800 rounded-lg border border-gray-700 text-sm">

        <option value="th">ðŸ‡¹ðŸ‡­ à¹„à¸—à¸¢</option>
      </select>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <div id="feedSection">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">ðŸ”¥ Trending</h2>
        <button onclick="loadHome()" class="text-sm text-gray-400 hover:text-white">Refresh</button>
      </div>
      <div id="feed" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4"></div>
    </div>

    <div id="playerModal" class="hidden fixed inset-0 z-50 bg-black/90 overflow-y-auto">
      <div class="min-h-screen flex items-start justify-center p-4">
        <div class="w-full max-w-4xl bg-gray-900 rounded-2xl overflow-hidden shadow-2xl my-8">
          <div class="relative bg-black aspect-video">
            <video id="videoPlayer" controls class="w-full h-full"></video>
            <button onclick="closePlayer()"
              class="absolute top-4 right-4 w-10 h-10 bg-black/50 rounded-full flex items-center justify-center hover:bg-black/70">âœ•</button>
          </div>
          <div class="p-5">
            <div class="flex items-start justify-between gap-4 mb-4">
              <div>
                <h2 id="dramaTitle" class="text-xl font-bold mb-1"></h2>
                <p id="dramaInfo" class="text-sm text-gray-500"></p>
              </div>
              <div class="flex gap-2">
                <select id="subtitleSelect" onchange="changeSubtitle()"
                  class="px-3 py-2 bg-gray-800 rounded-lg border border-gray-700 text-sm">
                  <option value="-1">Subtitle: Off</option>
                </select>
              </div>
            </div>
            <div class="flex items-center gap-3 mb-4">
              <select id="episodeSelect" onchange="playEpisode()"
                class="flex-1 px-4 py-2 bg-gray-800 rounded-lg border border-gray-700"></select>
            </div>
            <div id="status" class="text-sm text-gray-400"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div id="loading" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center">
    <div class="text-center">
      <div class="w-12 h-12 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
      <p class="text-gray-400">Memuat...</p>
    </div>
  </div>

  <script>
    const API = 'https://dramabos.asia/api/dramabox';
    let hls = null, currentDrama = null, chapters = [];
    const cache = new Map();

    function getLang() { return document.getElementById('langSelect').value; }
    function showLoading() { document.getElementById('loading').classList.remove('hidden'); }
    function hideLoading() { document.getElementById('loading').classList.add('hidden'); }

    async function fetchCached(url, ttl = 300000) {
      const now = Date.now();
      // Include lang in cache key
      const cacheKey = url + '_' + getLang();
      if (cache.has(cacheKey) && now - cache.get(cacheKey).time < ttl) return cache.get(cacheKey).data;
      const res = await fetch(url);
      const data = await res.json();
      cache.set(cacheKey, { data, time: now });
      return data;
    }

    function clearCache() {
      cache.clear();
    }

    async function searchDrama() {
      const q = document.getElementById('searchInput').value;
      if (!q.trim()) return loadHome();
      showLoading();
      try {
        // Dramabox search: /api/search/{query}/{page}?lang={lang}
        const json = await fetchCached(`${API}/api/search/${encodeURIComponent(q)}/1?lang=${getLang()}`);
        renderFeed(json.data?.list || [], `Hasil: "${q}"`);
      } catch (e) { document.getElementById('feed').innerHTML = '<p class="text-red-500 p-4">Error: ' + e.message + '</p>'; }
      hideLoading();
    }

    async function loadHome() {
      showLoading();
      try {
        // Dramabox home: /api/foryou/{page}?lang={lang}
        const json = await fetchCached(`${API}/api/foryou/1?lang=${getLang()}`);
        renderFeed(json.data?.list || [], 'ðŸ”¥ Trending');
      } catch (e) {
        console.error(e);
        document.getElementById('feed').innerHTML = '<p class="text-red-500 p-4">Error: ' + e.message + '</p>';
      }
      hideLoading();
    }

    function renderFeed(items, title) {
      document.querySelector('#feedSection h2').textContent = title;
      if (!items?.length) { document.getElementById('feed').innerHTML = '<p class="text-gray-500 p-4">Tidak ada hasil</p>'; return; }
      document.getElementById('feed').innerHTML = items.map(item => {
        // Dramabox uses different field names
        const img = item.coverWap || item.cover || '';
        const bookId = item.bookId || item.id;
        const bookTitle = item.bookName || item.name || item.title || '';
        const category = item.tags?.[0] || item.typeTwoName || item.typeOneName || 'Drama';
        return `
        <div class="card cursor-pointer group" onclick="selectDrama('${bookId}')">
          <div class="relative overflow-hidden rounded-xl mb-2">
            <img src="${img}" class="card-img w-full aspect-[3/4] object-cover bg-gray-800" loading="lazy" onerror="this.src='https://via.placeholder.com/300x400?text=No+Image'">
            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity flex items-end p-3">
              <span class="text-xs bg-cyan-600 px-2 py-1 rounded">${category}</span>
            </div>
          </div>
          <h3 class="font-medium text-sm leading-tight line-clamp-2 group-hover:text-cyan-400 transition-colors">${bookTitle}</h3>
        </div>`;
      }).join('');
    }

    async function selectDrama(bookId) {
      document.getElementById('playerModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      document.getElementById('status').textContent = 'Memuat...';
      document.getElementById('dramaTitle').textContent = '';

      try {
        // Dramabox detail: /api/drama/{bookId}?lang={lang} - contains chapterList with video URLs
        const json = await fetchCached(`${API}/api/drama/${bookId}?lang=${getLang()}`);
        const drama = json.data;
        if (!drama) { document.getElementById('status').textContent = 'Drama tidak ditemukan'; return; }

        currentDrama = { bookId, name: drama.bookName || drama.name || '' };
        document.getElementById('dramaTitle').textContent = currentDrama.name;
        document.getElementById('dramaInfo').textContent = `${drama.chapterCount || 0} Episode`;

        // Store chapters with video data from drama API
        chapters = drama.chapterList || [];

        document.getElementById('episodeSelect').innerHTML = chapters.map((ch, idx) =>
          `<option value="${idx}">${ch.chapterName || 'Episode ' + (ch.chapterIndex + 1)}</option>`
        ).join('');

        if (chapters.length) playEpisode();
      } catch (e) { document.getElementById('status').textContent = 'Error: ' + e.message; }
    }

    async function playEpisode() {
      if (!currentDrama || !chapters.length) return;
      const index = parseInt(document.getElementById('episodeSelect').value);
      const video = document.getElementById('videoPlayer');
      const chapter = chapters[index];

      if (!chapter) {
        document.getElementById('status').textContent = 'Episode tidak ditemukan';
        return;
      }

      document.getElementById('status').textContent = `Memuat ${chapter.chapterName || 'Episode ' + (index + 1)}...`;

      try {
        // Get video URL from chapter's cdnList -> videoPathList
        // Prefer 720p as default, fallback to any available quality
        let url = null;
        if (chapter.cdnList && chapter.cdnList.length > 0) {
          const cdn = chapter.cdnList.find(c => c.isDefault === 1) || chapter.cdnList[0];
          if (cdn.videoPathList && cdn.videoPathList.length > 0) {
            // Try to get 720p first (default), then any available
            const video720 = cdn.videoPathList.find(v => v.quality === 720);
            const videoDefault = cdn.videoPathList.find(v => v.isDefault === 1);
            const videoAny = cdn.videoPathList[0];
            url = (video720 || videoDefault || videoAny)?.videoPath;
          }
        }

        if (!url) {
          document.getElementById('status').textContent = 'Video tidak tersedia';
          return;
        }

        // Check if URL is HLS (.m3u8) or direct MP4
        const isHls = url.includes('.m3u8');

        if (hls) hls.destroy();

        if (isHls && Hls.isSupported()) {
          hls = new Hls({ maxBufferLength: 30, maxMaxBufferLength: 60 });
          hls.loadSource(url);
          hls.attachMedia(video);
          hls.on(Hls.Events.MANIFEST_PARSED, () => {
            video.play().catch(() => { });
            document.getElementById('status').textContent = chapter.chapterName || `Episode ${index + 1}`;
          });
          hls.on(Hls.Events.SUBTITLE_TRACKS_UPDATED, setupSubtitles);
          hls.on(Hls.Events.ERROR, (_, d) => { if (d.fatal) document.getElementById('status').textContent = 'Error: ' + d.details; });
        } else {
          // Direct MP4 playback
          video.src = url;
          video.play().catch(() => { });
          document.getElementById('status').textContent = chapter.chapterName || `Episode ${index + 1}`;
        }
      } catch (e) { document.getElementById('status').textContent = 'Error: ' + e.message; }
    }

    function setupSubtitles() {
      if (!hls?.subtitleTracks?.length) return;
      const sel = document.getElementById('subtitleSelect');
      sel.innerHTML = '<option value="-1">Subtitle: Off</option>' + hls.subtitleTracks.map((t, i) => `<option value="${i}">${t.name || t.lang}</option>`).join('');
      const lang = getLang() === 'id' ? 'ind' : getLang();
      const idx = hls.subtitleTracks.findIndex(t => t.lang?.includes(lang));
      if (idx >= 0) { sel.value = idx; hls.subtitleTrack = idx; hls.subtitleDisplay = true; }
    }

    function changeSubtitle() {
      if (!hls) return;
      const i = parseInt(document.getElementById('subtitleSelect').value);
      hls.subtitleTrack = i;
      hls.subtitleDisplay = i >= 0;
    }

    function closePlayer() {
      if (hls) { hls.destroy(); hls = null; }
      document.getElementById('videoPlayer').src = '';
      document.getElementById('playerModal').classList.add('hidden');
      document.body.style.overflow = '';
      currentDrama = null;
      chapters = [];
    }

    document.getElementById('searchInput').addEventListener('keypress', e => { if (e.key === 'Enter') searchDrama(); });
    loadHome();
  </script>
</body>

</html>